#!/bin/bash

# Define the path for the marked directories file
MARKED_PATH="$HOME/.marked"

# Function to ensure the marked file exists
ensure_marked_file() {
    if [ ! -e "$MARKED_PATH" ]; then
        touch "$MARKED_PATH"
    fi
}

# Function to mark the current directory
mark_path() {
    ensure_marked_file

    CURRENT_DIR=$(pwd)

    # Check if the current directory is already marked
    if grep -Fxq "$CURRENT_DIR" "$MARKED_PATH"; then
        echo "{$CURRENT_DIR} is already marked!!"
        exit 0
    fi

    # Save the first three old marks if they exist
    OLD_MARKS=$(head -3 "$MARKED_PATH")

    # Add the current directory to the marked path file
    {
        echo "$CURRENT_DIR"
        echo "$OLD_MARKS"
    } > "$MARKED_PATH"
    
    echo "Successfully marked {$CURRENT_DIR}"
}

# Function to switch or attach to a tmux session
jump_to_session() {
    if [ -n "$TMUX" ]; then
        tmux switch-client -t "$SELECTED_SESSION"
    else
        tmux attach -t "$SELECTED_SESSION"
    fi
}

# Function to create a new tmux session
create_new_session() {
    SESSION_NAME=$(basename "$SELECTED_SESSION")

    if [ -n "$TMUX" ]; then
        tmux new -c "$SELECTED_SESSION" -s "$SESSION_NAME" -d >> /dev/null
        tmux switch-client -t "$SESSION_NAME"
    else
        tmux new -c "$SELECTED_SESSION" -s "$SESSION_NAME" -A 
    fi
}

# Function to check if a tmux server is running
is_tmux_running() {
    tmux list-sessions &> /dev/null
}

# Main script logic
main() {
    case "$1" in
        new)
            # Select a directory to create a new session
            SELECTED_SESSION=$(find ~/.config ~/Repos -maxdepth 3 -type d | fzf)
            if [ -n "$SELECTED_SESSION" ]; then
                create_new_session
            else
                echo "No directory selected."
                exit 1
            fi
            ;;
        list)
            # List existing sessions and switch to selected one
            if is_tmux_running; then
                SELECTED_SESSION=$(tmux list-sessions -F "#{session_name}" | fzf)
                if [ -n "$SELECTED_SESSION" ]; then
                    jump_to_session
                else
                    echo "No session selected."
                    exit 1
                fi
            else
                echo "No tmux server running."
            fi
            ;;
        jump)
            # Jump to a marked directory session
            if [ -z "$2" ]; then
                echo "Please provide a line number to jump to."
                exit 1
            fi
			SELECTED_SESSION=$(sed -n "$2p" "$MARKED_PATH" | awk -F '/' '{print $NF}')
            if [ -n "$SELECTED_SESSION" ]; then
                create_new_session
            else
                echo "No marked directory found at line $2."
                exit 1
            fi
            ;;
        mark)
            # Mark the current directory
            mark_path
            ;;
        *)
            echo "Usage: $0 {new|list|jump <line_number>|mark}"
            exit 1
            ;;
    esac
}

# Execute main function with all script arguments
main "$@"

